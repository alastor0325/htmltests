<!DOCTYPE HTML>
<html>
<head>
  <title>Test PlayReady DRM support</title>
</head>
<body>
<h1>Open devtool to observe the result</h1>
<label for="framework">Select Kids</label>
<select id="KeyIdSelection">
  <option value="1">KIDS_3_H264</option>
  <option value="2">KIDS_3_HEVC</option>
  <option value="3">KIDS_4_VP9</option>
  <option value="4">KIDS_4_H264</option>
</select>
<button id="btn" onclick="EMETest()">Select Kids</button>
<script>

const KIDS = {
  // https://testweb.playready.microsoft.com/Content/Content3X
  "KIDS_3_H264" : '{"kids":["a2c786d0f9ef4cb3b333cd323a4284a5"]}',
  "KIDS_3_HEVC" : '{"kids":["35d1637939a34cc1aac97200ae23b0e5"]}',
  // https://testweb.playready.microsoft.com/Content/Content4X
  "KIDS_4_VP9"  : '{"kids":["0000000003fceacd0000000000000000"]}',
  "KIDS_4_H264"  : '{"kids":["10000000100010001000100000000001"]}',
}

function getKidsFromSelect() {
  const sb = document.querySelector('#KeyIdSelection');
  const selectedValues = [].filter
    .call(sb.options, option => option.selected)
    .map(option => option.text);
  console.log(selectedValues + ":" + KIDS[selectedValues]);
  return KIDS[selectedValues];
}

function EMETest() {
  var configs = [{
    initDataTypes: ['keyids', 'cenc'],
    audioCapabilities: [{ contentType: `audio/mp4;codecs="mp4a.40.2"` }],
    videoCapabilities: [{ contentType: `video/mp4;codecs="avc1.640028"` }],
    sessionTypes : ["persistent-license"],
  }];

  navigator.requestMediaKeySystemAccess('com.microsoft.playready.recommendation', configs)
    .then(
      (access) => {
        console.log('creating media key');
        access.createMediaKeys()
          .then(
            (mediaKeys) => {
              console.log('creating media session');
              var session = mediaKeys.createSession('persistent-license');
              session.addEventListener('message', event => {
                console.log(`MediaKeyMessage type is '${event.messageType}'`);
                session.close().then(() => { console.log(`closed session`); });
              });
              return session.generateRequest(
                'keyids',
                new TextEncoder().encode(getKidsFromSelect()));
            },
            _ => {
              console.log(`failed to create media key`);
            });
      },
      _ => {
        console.log(`failed to request key system access`);
      });
}

window.onload = EMETest;

</script>
</body>
</html>
